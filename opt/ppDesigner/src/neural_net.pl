#!/usr/bin/perl -w

#Copyright 2009, 2010 The Regents of the University of California.  All Rights Reserved.

sub neural_net_capture()
{

	my ($x1,$x2,$x3,$x4,$x5,$x6,$x7) = @_;

	my $IW = [
	[-0.433107377,-0.403028230,0.238158626,-0.422667805,0.210766527,2.329020937,2.656463077],
	[1.9772,1.0835,-0.8636,-0.6730,0.0459,0.5746,0.5514],
	[-0.4080,-1.2991,-0.2054,-1.1599,-0.8038,0.1881,-1.9764],
	[1.0297,1.3293,-0.4085,0.3283,-0.7775,-0.0474,0.4650],
	[0.6982,1.0029,0.6930,-0.9339,0.7503,-0.5127,0.0641],
	[-0.9475,0.3531,-1.3647,-0.4516,0.1036,0.0050,-0.6439],
	[0.2791,1.0124,-1.2487,-0.1557,0.2674,-0.1226,0.8729],
	[-0.2131,-0.2373,-1.2728,0.3924,-0.1600,0.0724,0.0887],
	[0.2257,-0.6820,-1.0380,0.1953,-0.4583,-0.1408,0.7487],
	[1.5626,0.4730,1.3174,0.4611,0.6927,1.4268,1.9581],
	[-0.0740,2.1704,0.9784,0.2071,0.4991,0.0010,0.1210],
	[2.1320,1.3586,-0.0336,-1.8560,0.0558,-0.3957,0.7373],
	[-0.0923,1.4856,0.8609,0.7403,1.8641,-0.3573,-0.5777],
	];

	my $LW1 = [
	[-1.4738,-0.4266,0.3565,0.3842,1.3204,1.2525,-0.3194,-1.1206,-0.3991,-0.3138,0.3669,0.2004,-0.0200],
	[2.7500,-1.4663,-0.4541,1.1039,-0.1408,-0.0982,0.3197,0.0335,0.3621,-0.2227,0.3559,-0.5349,2.0041],
	[0.8385,-0.3279,0.5094,-0.9218,-0.4714,-1.1044,1.1383,-0.9825,-0.8700,-1.1177,-0.5671,-0.5294,-3.7347],
	[0.1671,0.1213,-0.6294,-0.5252,-1.0041,-0.5403,-0.6664,-0.1034,-0.2879,-0.3661,-1.5305,0.6366,0.3935],
	[-0.1932,0.2580,-1.1062,-0.6706,-0.2259,-1.1587,-0.4080,-1.4218,0.8304,1.0476,-1.3241,-1.0575,1.2035],
	[0.1613,-0.3727,0.0212,-0.6605,-0.5784,1.4498,0.4122,1.3759,1.1887,0.9188,0.6198,0.9276,-0.3788],
	[0.0907,-0.3076,1.0393,-0.0324,0.5591,-0.3399,-0.9338,1.0003,-0.0568,0.3698,0.2679,-0.4482,-0.4577],
	[0.0312,-0.2246,-0.8456,-0.7228,-0.9165,-1.0531,-1.0925,0.7833,-0.2728,-0.7123,-0.0223,-0.9979,0.4237],
	];

	my $LW2 = [
	[0.1257,-0.0285,0.7260,-0.6445,-0.6187,-0.9186,0.5134,-0.7002],
	[0.0367,-0.2774,0.7774,-0.3691,-1.4375,0.6462,-0.1937,-0.5167],
	[-0.8902,1.9944,0.3698,0.6220,-0.3335,-0.2184,-0.5774,0.2307],
	[0.8896,1.2271,-0.3803,-1.4700,0.9727,-0.6642,-1.9776,1.0388],
	[0.7290,-0.2955,0.1974,0.8831,-0.0712,0.8664,-0.2545,-0.7143],
	];

	my $LW3=[
	[-0.6386,-0.0798,-0.5831,-0.3847,0.3093],
	];

	my $b1 = [
	[-4.0777],
	[-0.0928],
	[1.6501],
	[-1.8842],
	[0.1342],
	[1.0469],
	[-0.6687],
	[-0.4057],
	[0.7358],
	[0.8234],
	[-2.0007],
	[1.8862],
	[2.7173],
	];

	my $b2 = [
	[1.7913],
	[0.7355],
	[-0.0324],
	[0.0123],
	[-0.4912],
	[0.5442],
	[-0.8953],
	[-2.0460],
	];

	my $b3 = [
	[2.4156],
	[-1.0767],
	[-0.2667],
	[1.7061],
	[1.7286],
	];

	my $b4 = [
	[-0.4938],
	];

my $x1max=1.4000;
my $x2max=225.0000;
my $x3max=0.7400;
my $x4max=72.0000;
my $x5max=71.0000;
my $x6max=30.0000;
my $x7max=30.0000;

my $x1min=-51.3400;
my $x2min=150.0000;
my $x3min=0;
my $x4min=55.0000;
my $x5min=50.0000;
my $x6min=18.0000;
my $x7min=12.0000;

my $resmin = 0;
my $resmax = 4.6433;

	my $inputs = [
	[2*($x1-$x1min)/($x1max-$x1min) - 1],
	[2*($x2-$x2min)/($x2max-$x2min) - 1],
	[2*($x3-$x3min)/($x3max-$x3min) - 1],
	[2*($x4-$x4min)/($x4max-$x4min) - 1],
	[2*($x5-$x5min)/($x5max-$x5min) - 1],
	[2*($x6-$x6min)/($x6max-$x6min) - 1],
	[2*($x7-$x7min)/($x7max-$x7min) - 1],
	];

	#NeuralNet
	my $inter1 = mmult($IW,$inputs);
	my $inter2 = matadd($inter1,$b1);
	my $A1 = tansig($inter2);
	my $A2 = tansig(matadd(mmult($LW1,$A1),$b2));
	my $A3 = tansig(matadd(mmult($LW2,$A2),$b3));
	my $result = matadd(mmult($LW3,$A3),$b4);

	return (($result->[0][0])+1)*($resmax-$resmin)*0.5 + $resmin;
}

sub neural_net_capture_LC()
{

	my ($x1,$x2,$x3,$x4,$x5,$x6,$x7,$x8,$x9) = @_;

	my $IW = [
	[0.025610488,-0.065046288,0.13615669,-1.134520143,-0.314862573,-0.360029465,-0.985837947,-0.96579345,-1.211651912],
	[0.248375217,0.156630434,-0.334275948,0.753841287,0.229686834,1.112956525,-1.127575459,0.250994143,1.747164235],
	[1.150095031,-1.490887469,-0.400873392,-0.182098474,0.477992284,1.509967017,0.423891526,0.72441185,-0.549177965],
	[0.254243617,0.934366792,0.130080823,-1.738109076,-0.495726599,0.095711948,-0.243959929,0.743136062,0.874437369],
	[1.191350297,0.263651994,0.243267936,0.306967902,0.139356174,-0.362538867,0.342755752,-0.216028932,-0.152276636],
	[-0.651895661,1.474179845,1.502597952,-1.266489333,-0.106341607,0.177832246,-0.985441108,0.710120001,-1.177293528],
	[0.04631023,0.026935526,1.373084279,0.563960875,-1.450970895,-0.009073462,0.375340246,-0.432842997,0.095105284],
	[0.501013804,-0.00369223,-1.22288022,-1.054479238,0.233025305,0.012127489,0.470052383,-0.710557453,1.290200696],
	[1.487149387,-1.678966532,0.663783382,-0.04998356,0.079195184,-1.125104723,0.965243889,0.466064606,0.802515455],
	[-0.789332986,0.624866693,0.223931837,-1.398079171,0.026671672,0.77962753,-0.030528113,0.232817986,-0.730698349],
	[1.328640232,-0.058962321,-0.760075638,0.041944624,1.510509492,-0.6294844,1.029095846,0.252524763,-1.65334683],
	[-0.356932284,-0.295739859,-0.412806741,-0.669963266,0.43294469,0.579778737,0.195078726,0.10818805,-0.13206061],
	[-0.843614622,-0.207246757,0.398203684,-0.719052505,0.526921499,0.669604374,0.385879428,0.906027589,0.010637247],
	];

	my $LW1 = [
	[1.518892161,0.317199351,-0.782773552,-0.503561756,0.283382305,-1.872299831,0.755210813,-0.277264829,-0.927831206,-0.380759598,0.109874326,-0.156359096,1.273549399],
	[-0.777999391,1.075552372,0.772117696,0.022113499,-0.111447091,0.005652229,0.911168592,-0.365731295,-2.237082484,-0.196052797,0.829592002,-1.98488508,-0.622423831],
	[-0.516305589,1.461050029,-0.150900723,0.018321223,-0.686449624,0.516537471,1.178413432,1.767577578,0.291189898,-0.547583162,0.194325632,-0.56352196,0.04968441],
	[0.433511087,-0.982123634,-0.181084246,1.210762441,-0.050941032,0.664832094,-0.849189685,0.063289068,0.096852864,-1.53828526,0.073008987,-1.050119311,-1.067277955],
	[-2.009763785,-0.785746556,-0.163580036,0.234289268,0.451107023,0.185029934,-0.046670462,-1.31797857,-0.682337618,-0.832182227,0.348929543,0.312329046,0.745843593],
	[-0.026566921,1.772583476,1.299189365,-1.338690708,-0.646961224,-0.966599831,0.35431365,0.359235307,0.216978404,-0.646857465,-1.466624094,-0.349440388,-0.570579587],
	[-0.442938932,-0.668311475,-0.440568382,0.360685303,1.768343959,0.595896569,-0.273800769,-1.025650845,0.270640848,0.239337184,-0.617300733,-1.348918191,-1.482446059],
	[1.325385307,-0.102292696,0.206070187,0.856935867,1.504051134,0.29442861,-0.163950368,1.008458711,-0.446870424,-0.420065292,-0.107507775,0.84457219,-0.827796644],
	];

	my $LW2 = [
	[-0.188364128,0.799798817,0.777075958,0.669381424,-1.143812231,-0.116105563,-1.664320723,-1.690099924],
	[-0.809263051,-1.188177848,0.12676204,0.438820937,1.041238372,0.371224881,0.439342554,-2.07217877],
	[-0.592919904,0.107009601,0.22632494,-0.799129983,-0.023443606,0.418429002,-1.522613626,0.013965814],
	[-0.158049252,-1.134863529,-0.81022764,-0.82621182,0.512512875,0.265747454,1.951710342,-0.475352479],
	[0.591648364,0.727598331,-0.70920829,2.314332487,0.670380448,-0.739424976,-1.499094976,-1.378231018],
	];

	my $LW3=[
	[-0.000014374118164,0.000001987241358,-0.000071923873573,-0.000036932540186,0.000067151479964],
	];

	my $b1 = [
	[1.533238646],
	[-0.169873454],
	[-1.50006915],
	[-0.862148845],
	[-0.110275432],
	[-0.47173142],
	[-0.439025491],
	[-1.882771014],
	[1.077137587],
	[-0.986803541],
	[1.072062888],
	[-0.960823899],
	[-0.941702512],
	];

	my $b2 = [
	[-0.719385008],
	[1.995220178],
	[1.127430319],
	[-1.945105944],
	[0.765951387],
	[1.967157974],
	[1.785611083],
	[-1.559673591],
	];

	my $b3 = [
	[0.277590907],
	[-1.273247666],
	[1.547356682],
	[0.139279143],
	[1.540415516],
	];

	my $b4 = [
	[-0.999821363],
	];

my $x1min=15.0000000000;
my $x2min=15.0000000000;
my $x3min=50.0000000000;
my $x4min=50.0000000000;
my $x5min=178.0000000000;
my $x6min=0.1011235960;
my $x7min=1.0000000000;
my $x8min=1.0000000000;
my $x9min=-26.6200000000;

my $x1max=25.0000000000;
my $x2max=25.0000000000;
my $x3max=69.0000000000;
my $x4max=68.0000000000;
my $x5max=180.0000000000;
my $x6max=0.7359550560;
my $x7max=9.0000000000;
my $x8max=9.0000000000;
my $x9max=0.9400000000;

my $resmin = 0.000000000;
my $resmax = 4.106870544;

	my $inputs = [
	[2*($x1-$x1min)/($x1max-$x1min) - 1],
	[2*($x2-$x2min)/($x2max-$x2min) - 1],
	[2*($x3-$x3min)/($x3max-$x3min) - 1],
	[2*($x4-$x4min)/($x4max-$x4min) - 1],
	[2*($x5-$x5min)/($x5max-$x5min) - 1],
	[2*($x6-$x6min)/($x6max-$x6min) - 1],
	[2*($x7-$x7min)/($x7max-$x7min) - 1],
	[2*($x8-$x8min)/($x8max-$x8min) - 1],
	[2*($x9-$x9min)/($x9max-$x9min) - 1],
	];

	#NeuralNet
	my $inter1 = mmult($IW,$inputs);
	my $inter2 = matadd($inter1,$b1);
	my $A1 = tansig($inter2);
	my $A2 = tansig(matadd(mmult($LW1,$A1),$b2));
	my $A3 = tansig(matadd(mmult($LW2,$A2),$b3));
	my $result = matadd(mmult($LW3,$A3),$b4);

	return (($result->[0][0])+1)*($resmax-$resmin)*0.5 + $resmin;
}

sub mmult {
    my ($m1,$m2) = @_;
    my ($m1rows,$m1cols) = matdim($m1);
    my ($m2rows,$m2cols) = matdim($m2);

    unless ($m1cols == $m2rows) {  # raise exception
        die "IndexError: matrices don't match: $m1cols != $m2rows";
    }

    my $result = [];
    my ($i, $j, $k);

    for $i (range($m1rows)) {
        for $j (range($m2cols)) {
            for $k (range($m1cols)) {
                $result->[$i][$j] += $m1->[$i][$k] * $m2->[$k][$j];
            }
        }
    }
    return $result;
}

sub tansig()
{
	my $mat = shift;
	
	my ($matrows,$matcols) = matdim($mat);
	
	my ($i,$j);
	
	my $outmat = [];
	for $i (range($matrows)) {
		for $j (range($matcols)) {
			$outmat->[$i][$j] = 2/(1+exp(-2*($mat->[$i][$j]))) - 1;
		}
	}
	
	return $outmat;
}

sub matadd()
{
	my ($m1,$m2) = @_;
	my ($m1rows,$m1cols) = matdim($m1);
	my ($m2rows,$m2cols) = matdim($m2);
	
	unless(($m1rows == $m2rows) && ($m1cols == $m2cols))
	{
		die "IndexError: Cannot add matrices of different sizes";
	}
	
	my $result = [];
	my ($i, $j);
	
	for $i (range($m1rows)) {
		for $j (range($m1cols)) {
			$result->[$i][$j] = $m1->[$i][$j] + $m2->[$i][$j];
		}
	}
	
	return $result;
}

sub range { 0 .. ($_[0] - 1) }

sub veclen {
    my $ary_ref = $_[0];
    my $type = ref $ary_ref;
    if ($type ne "ARRAY") { die "$type is bad array ref for $ary_ref" }
    return scalar(@$ary_ref);
}

sub matdim {
    my $matrix = $_[0];
    my $rows = veclen($matrix);
    my $cols = veclen($matrix->[0]);
    return ($rows, $cols);
}

1;
